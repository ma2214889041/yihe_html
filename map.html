<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>高德地图定位示例</title>
  <script src="https://webapi.amap.com/maps?v=1.4.15&key=36ad54204561f8044ed21fb739f5abe4"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    #container {
      width: 100%;
      height: 100vh;
      position: relative;
    }
    #confirmButton {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    #confirmButton:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #confirmButton:active {
      transform: translateX(-50%) scale(0.95);
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <button id="confirmButton" disabled>确认位置</button>
  <script>
    var map = new AMap.Map('container', {
      resizeEnable: true,
      zoom: 15
    });
    var currentLocation = null;
    var locationMarker = null;

    map.plugin('AMap.Geolocation', function() {
      var geolocation = new AMap.Geolocation({
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0,
        convert: true,
        showButton: true,
        buttonPosition: 'RB',
        buttonOffset: new AMap.Pixel(10, 20),
        showMarker: false,
        showCircle: true,
        panToLocation: true,
        zoomToAccuracy: true
      });
      map.addControl(geolocation);
      geolocation.getCurrentPosition();
      AMap.event.addListener(geolocation, 'complete', onComplete);
      AMap.event.addListener(geolocation, 'error', onError);
    });

    function onComplete(data) {
      currentLocation = {
        longitude: data.position.getLng(),
        latitude: data.position.getLat()
      };
      if (locationMarker) {
        locationMarker.setPosition([currentLocation.longitude, currentLocation.latitude]);
      } else {
        locationMarker = new AMap.Marker({
          position: [currentLocation.longitude, currentLocation.latitude],
          map: map
        });
      }
      map.setCenter([currentLocation.longitude, currentLocation.latitude]);
      document.getElementById('confirmButton').disabled = false;
    }

    function onError(error) {
      alert('定位失败，请重试');
    }

    document.getElementById('confirmButton').addEventListener('click', function() {
      if (currentLocation) {
        this.textContent = '确认中...';
        this.disabled = true;
        
        // 向飞书小程序发送消息
        if (window.tt && window.tt.postMessage) {
          window.tt.postMessage({
            action: 'confirmLocation',
            data: currentLocation
          });
        } else {
          console.error('无法与飞书小程序通信');
          this.textContent = '确认失败';
          this.disabled = false;
        }
      }
    });
  </script>
</body>
</html>
